---
title: "Kamailio: HTable"
excerpt: "Notes about kamailio"
permalink: /kamailio/htable/
header:
  image: "/assets/images/academy/kamailio.svg"
last_modified_at: 2023-03-21 21:00:00 +00:00
toc: true
---

## htable

htable `$sht(htname=>key)` is an Hash Table stored in shared memory, implemented by the module htable.
A typical use case for the SIP server is to implement a cache system.

An iten is a pair of `key, value` (string,integer/string).
The key can contain other PVs which is evaluated at runtime and the values can be loaded at startup from a database table.

```c#
loadmodule "htable.so"

modparam("htable", "htable", "cps=>size=3;initval=0;autoexpire=30")

request_route {
  // $sht(cps=>test) is the logical link to the Htable called cps with a key named $si
  // we are increasing the source IP's counter by 1
  $sht(cps=>$si) = $sht(cps=>$si) + 1;

  if($sht(cps=>$si) > 3){
    xlog("$si is back again, rate limiting them...");
    sl_send_reply("403", "CPS exceeded");
    exit;
  }

  xlog("$si is $sht(cps=>$si) ");
  sl_send_reply("403", "CPS exceeded");

}
```

Itens in a hash table are single values: assignemetns overwrite the previous value (to delete use `$null`).
The  number of itens is limited by the sgahred memory.

> If there's a large number of itens, it's recommended to increase the size, to make the search faster (lower collision rate in the same slot).

Updates done in one step are safe to be done without locking, but if you need to do multiple operations, you should use it:

```c#
var(a)=1;
lock(key);
$sht(id=>key) = $sht(id=>key) + var(a);
unlock(key);
```

The module also provides a way to store multiple values for a single key. This is emulated by storing individual keys as 'key_name[n]', where n is incremented for each key. The total number of keys is stored in a dedicated key, by default: 'key_name::size'.


The definition of a hash table. The value of the parameter may have the following format:

`"htname=>size=_number_;autoexpire=_number_;dbtable=_string_"`
