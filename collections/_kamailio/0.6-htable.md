---
title: "Kamailio: AVP"
excerpt: "Notes about kamailio"
permalink: /kamailio/avp/
header:
  image: "/assets/images/academy/kamailio.svg"
last_modified_at: 2023-03-21 21:00:00 +00:00
toc: true
---

## htable

htable `$sht(htname=>key)` is an Hash Table stored in shared memory, implemented by the module htable.
A typical use case for the SIP server is to implement a cache system.

An iten is a pair of `key, value` (string,integer/string).
The key can contain other PVs which is evaluated at runtime and the values can be loaded at startup from a database table.

```c#
loadmodule "htable.so"

modparam("htable", "htable", "cps=>size=3;initval=0;autoexpire=30")

request_route {
  // $sht(cps=>test) is the logical link to the Htable called cps with a key named $si
  // we are increasing the source IP's counter by 1
  $sht(cps=>$si) = $sht(cps=>$si) + 1;

  if($sht(cps=>$si) > 3){
    xlog("$si is back again, rate limiting them...");
    sl_send_reply("403", "CPS exceeded");
    exit;
  }

  xlog("$si is $sht(cps=>$si) ");
  sl_send_reply("403", "CPS exceeded");

}
```
