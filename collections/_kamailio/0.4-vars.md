---
title: "Kamailio: Data Structures"
excerpt: "Notes about kamailio"
permalink: /kamailio/vars/
header:
  image: "/assets/images/academy/kamailio.svg"
last_modified_at: 2023-03-21 21:00:00 +00:00
toc: true
---

## Data Structures

> :information_source: **Note:** Read the [offical docs](https://www.kamailio.org/wikidocs/cookbooks/devel/core/) to get the most updated information.
> Read the [sip concepts](/sip/concepts/) to get a better understanding of the concepts discussed.

### Values

There are three types of values:
* `integer` - numbers of 32bit size
* `boolean` - an integer aliases to 1 (true, on, yes) or 0 (false, off, no)
* `ID` an aphphanumeric special token not enclosed in quotes.
* `string`  - an alphanumeric tokens in `"double"` or `'single'` quotes (can be split in manny tokens `"abc" "def"`)
* `network attribute` an address `1.1.1.1`, `1.1.1.1/32`, ipv4 or ipv6.

### Keywords

Core Keywords specific to SIP messages which can be used mainly in if expressions.

```c#
af      // address family of the received SIP message
dst_ip / dst_port        // local where was received
proto   // transport protocol
method  // SIP method
msg:len // size of the message
        // in onsend_route will count with all the changes applied
status  // in onreply_route, it's a referece to the status code of the reply
snd_af / snd_ip / snd_port / snd_proto // local that will use to send the message
src_ip / src_port        // from which the message was sent by previous hop
from_uri                 // URI of 'From' header
to_ip / to_port / to_uri // the message will be sent to
uri     // value of the request URI
```

##### Core Values

Constant values that can be used in 'if' expressions to check against Core Keywords

* protocols that can be compared `af: INET, INET6`,  `proto: SCTP, TCP, TLS, UDP, WS, WSS`
* `myself` list of local IP addresses, hostnames and aliases that has been set. To test against `uri` or `ip` keywords. Alternative: `is_myself()` function.

```c
  if(uri==myself) {
    xlog("local message: uri == myself\n");
  };
```

Which results in ` 1(8) ERROR: <script>: local message: uri == myself`


### Variables

The variables start with `$` character. Also called a Pseudo-variable because some are:
 * read-only
 * hold multiple values
 * a reference for a sip message
 * stored in private or shared memory
 * can be represented as `$class | $class(key) | $(class(key)) | $(class(name)[index])`

**Classes:** Majority of varaibles are in module `pv` and read-only (such as `$(hdr(name)[N])`  content of the headers), with the exceptions:
  * `$var(name)` - script private variable: This kind of variables are faster, being referenced directly to memory location.
  * `$shv(name)` - shared value variable
  * `$avp(x) | $xavp` - Unordered List Attribute-Value Pair 
  * `$sht(hash=>name)` - shared hash table variable
  * and some sip message attributes
    * `$br` - request's first branch
    * `$bf` - branch flags of branch 0 (RURI) - decimal output
    * `$bF` - branch flags of branch 0 (RURI) - hexa output
    * `$du` - destination uri
    * `$fd` - domain in URI of 'From' header
    * `$fn` - display name of 'From' header
    * `$fs` - the forced send socket for the SIP message
    * `$fu` - URI of 'From' header
    * `$fU` - username in URI of 'From' header
    * `$mf` - message/transaction flags set for current SIP request
    * `$mF` - message/transaction flags set for current SIP request in hexa-decimal
    * `$rd` - domain in request's URI (without port)
    * `$rp` - port of R-URI
    * `$ru` - request's URI 
    * `$rU` - username in request's URI 
    * `$td` - domain in URI of 'To' header
    * `$tn` - display name of 'To' header
    * `$tu` - URI of 'To' header
    * `$tU` - username in URI of 'To' header

**Private memory:** no reloading, one copy per process
* `$ru` and other sip message attributes
* `$(hdr(name)[N])`
* `$var(name)`

**Shared memory:** I you need to use a variable in a request and response, a shared variable should be used. The sip message is processed in private memory and moved to shared memory when when a transaction is created.
  * `$shv(name)`
  * `$avp(x) | $xavp`
  * `$sht(hash=>name)`

#### var

`$var(name) | $vz(name)` - Very fast variable with single value stored in private memory (each process has its own value)
* Initial value is 0. Can have integer or string value.
* Can be initialized to another value using modparam `"varset"`
* Assignment to `$null` sets it to 0 (variant `$vn(name)` can hold `$null` value

```c
// simple server that will always reply
// with "200 OK Hello, World! and log"
#!KAMAILIO

loadmodule "xlog" // to use xlog
loadmodule "pv"   // to use $var
loadmodule "sl"   // to use sl_send_reply

request_route {
    $var(name) = "Hello, World!";

    xlog("$$var(name): $var(name)\n");
    sl_send_reply(200, "OK $var(name)");
}

```

This will get logged:

```log
 9(16) ERROR: <script>: Hey - $var(def): DEF yoo | xterm
 9(16) ERROR: <script>: def
 9(16) ERROR: <script>: try else
```

```c#
// stateless proxy that will always forward the message
// and log the value of the variable
#!KAMAILIO

loadmodule "xlog"
loadmodule "pv"
loadmodule "sl"

request_route {
    $var(name) = "Hello, World!";

    xlog("$$var(name): $var(name)\n");
    forward("10.0.0.2", 5060);
}

reply_route{
    xlog("Got a reply $rs $du\n");
    xlog("$$var(name): $var(name)\n");
}
```

##### shv

`$shv(name)` - Very fast rw operations (slower that `$var(name`) variable with single value stored in shared memory `shm` (survives multiple SIP message processing)
* Initial value is 0. Can have integer or string value.
* Can be initialized to another value using modparam of pv module
* Assignment to $null sets it to 0
* Stored in Kamailio instance context protected by mutex (all processes have the same value)
* Can be read and updated via RPC commands




```c#
#!KAMAILIO

loadmodule "xlog"
loadmodule "pv"
loadmodule "sl"

modparam("pv", "shvset", "shv_a=s:")

request_route {
    xlog("Got a request $rm to $ru\n");

    $var(a) = "var_a Hello, World!";
    $shv(a) = "shv_a Hello, World!";

    xlog("request $$var(a): $var(a)\n");
    xlog("request $$shv(a): $shv(a)\n\n");

    forward("10.0.0.2", 5060);
}

reply_route{
    xlog("Got a reply $rs $rm\n");

    xlog("reply $$var(a): $var(a)\n");
    xlog("reply $$shv(a): $shv(a)\n");
}
```

##### How to test

```console
  ## run a kamailio docker image with the kamailio.cfg above
~ $ sudo docker run -it --rm --name kam --net host -v "$(pwd):/etc/kamailio/" kamailio/kamailio:5.6.4-bullseye
  ## send options to your private ip
~ $ sipexer 192.168.1.100
```

##### resources
* [Wiki Pseudo-Variables Cookbook](https://www.kamailio.org/wikidocs/cookbooks/devel/pseudovariables/)
* [Wiki Core Cookbook](https://www.kamailio.org/wikidocs/cookbooks/devel/core/)
