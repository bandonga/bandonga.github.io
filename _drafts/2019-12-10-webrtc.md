---
title: WebRTC
date: 2018-10-31 00:00:00 +01:00
header:
  teaser: "/assets/images/academy/webrtc.png"
  image: "/assets/images/academy/webrtc.png"
categories:
- academy
tags:
- academy
- telephony
excerpt: "A guide to help you know more about WebRTC."
---

A guide to help you know more about WebRTC.

###### Introduction

WebRTC offers real time communication to send media  natively from a web-browser.
Is also a media engine with standardize javascript APIs, handled by the IETF and W3C.

webrtc.org is a open source project (software stack) that holds an implementation of the specification

While we still need to somehow signal from one browser to the other so we will be able to locate each other, once that signaling is over, we can send them messages directly between the two browsers – without the web server ever touching the messages
This is why many refer to WebRTC as a peer-to-peer technology.

WebRTC protocol stack

![img](https://hpbn.co/assets/diagrams/f91164cbbb944d8986c90a1e93afcd82.svg)

Needs clients and servers.

##### Main APIs
* `getUserMedia` acquires the audio and video media (by accessing a device's camera, screen or microphone). No used for video calling.
* `RTCPeerConnection` enables audio and video communication between peers. It performs signal processing, codec handling, peer-to-peer communication, security, encoding, NAT  and bandwidth management.
* `RTCDataChannel` allows bidirectional communication of arbitrary data between peers. It uses the same API as WebSockets and has very low latency.

The WebRTC API also includes a statistics function:
`getStats` allows the web application to retrieve a set of statistics about WebRTC sessions.

--------------------------------------------------------------------------------

* `getUserMedia`

`getUserMedia` will create a MediaStream, that is a container that can contain multiple MediaStreamTraks (video, sterio audio). This tracks will be synced in time.
A MediaStreamTraks is a set of channels from the same type.

![img](https://dev.w3.org/2011/webrtc/editor/images/media-stream.png)

The output is sent to one or more destinations with local `<audio>` or `<video>` html5 element and javascript to process it or in RTCPeerConnection.
Web Audio and WebGl APIs can be used to process the media.

* `RTCPeerConnection`

main APIs

createOffer()
The createOffer() method of the RTCPeerConnection interface initiates the creation of an SDP offer for the purpose of starting a new WebRTC connection to a remote peer.
createAnswer()
The createAnswer() method on the RTCPeerConnection interface creates an SDP answer to an offer received from a remote peer during the offer/answer negotiation of a WebRTC connection. The answer contains information about any media already attached to the session, codecs and options supported by the browser, and any ICE candidates already gathered. The answer is delivered to the returned Promise, and should then be sent to the source of the offer to continue the negotiation process.
setLocalDescription()
The RTCPeerConnection.setLocalDescription() method changes the local description associated with the connection. This description specifies the properties of the local end of the connection, including the media format.
setRemoteDescription()
The RTCPeerConnection.setRemoteDescription() method sets the specified session description as the remote peer's current offer or answer. This description specifies the properties of the remote end of the connection, including the media format.
addStream()  
addTrack()
The RTCPeerConnection method addTrack() adds a new media track to the set of tracks which will be transmitted to the other peer. replaced addStream
The RTCPeerConnection.removeTrack() method tells the local end of the connection to stop sending media from the specified track, without actually removing the corresponding RTCRtpSender. replaced removeStream

Connection steps - register the different callbacks.
* Register onicecandidate -  The RTCPeerConnection property onicecandidate property is an EventHandler which specifies a function to be called when the icecandidate event occurs on an RTCPeerConnection instance. This happens whenever the local ICE agent needs to deliver a message to the other peer through the signaling server. deals with the ICE candidates received by the from the STUN/TURN server.
* Register ontrack - EventHandler which specifies a function to be called when the track event occurs, indicating that a track has been added to the RTCPeerConnection. When there is a stream you want to play locally. replaced onaddstream
* Register message - used for the signaling part.
* Use getUserMedia - get the local streams to send over.
* Go for JSEP offer/answer - protocol used on top of SDP to connect the call.



@startuml

!includeurl https://raw.githubusercontent.com/bandonga/plantuml-diagrams/master/skin_clear.puml!0

participant "App 1" as app1
participant "Browser 1" as browser1
participant "Signaling Server" as signaling
participant "Browser 2" as browser2
participant "App 2" as app2


app1      ->  browser1: ""getUserMedia""
browser1  ->  app1: ""gotStream(localStream)""
app1      ->  browser1: Create ""RTCPeerConnection""
app1      ->  browser1: ""addStream(localStream)""
app1      ->  browser1: ""createOffer""
browser1  ->  app1: ""onCreateOfferSuccess(sdp)""
app1      ->  browser1: ""setLocalDescription(sdp)""
browser1  ->  app1: ""onSetLocalSuccess(sdp)""

app1      ->  signaling: send SDP
signaling ->  app2: send SDP



app2      ->  browser2: Create ""RTCPeerConnection""
app2      ->  browser2: ""setRemoteDescription(sdp)""
browser2  ->  app2: ""onSetRemoteSuccess()""
app2      ->  browser2: ""CreateAnswer""
browser2      ->  app2: ""onCreateAnswerSuccess(sdp)""
app2  ->  browser2: ""SetLocalSuccess(sdp)""
browser2  ->  app2: ""onSetLocalSuccess()""

app2      ->  signaling: send SDP
signaling ->  app1: send SDP

app1      ->  browser1: ""setRemoteDescription(sdp)""
browser1  ->  app1: ""onSetRemoteSuccess()""

@enduml

Example: https://webrtc.github.io/samples/src/content/peerconnection/pc1/

https://github.com/webrtc/samples/blob/gh-pages/src/content/peerconnection/pc1/js/main.js
https://github.com/webrtc/samples/blob/gh-pages/src/content/peerconnection/multiple-relay/js/main.js

https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling
https://www.pkc.io/blog/untangling-the-webrtc-flow/


ICE candidate process will happen parallel to the offer/answer mechanism. After this the media can start flowing.

* `RTCDataChannel`







##### Browser architecture
Browser
Browser Engine > chromium  and has the implementation of WebRTC
Renderer Blink: Fork of webkit
Runtime Javascript V8

![img](https://miro.medium.com/max/803/1*UPTde0WH3eD6Kpo_82ziVA.png)


Electro > based in chromium Blink V8 and Node JS Window

##### Connection


* Browser/Application
* webserver - that runs the logic of the app
* signaling servers - send the sdp to negotiate media, with stateful information
* nat servers - ICE procedure to have allow to route the media between the devices
* media servers - manage and convert media
  * SFU media router
  * MCU - media mixer
  * recording server

Steps to connect a WebRCT session
* Discovery - How to find the user, out of scope of WebRTC. locate our destination and being able to reach the user.
* Negotiation - Negotiate the session parameter by the application, negotiate the connection of the users or the media server gateways.
* Conversation - Getting the session connected and sending the media.

JSEP Negotiation (Javascript Session Establishment Protocol)
offer  - offer blob (SDP) and an answer.

* User A create a OFFER. The application sends the OFFER through a signaling server.
* OFFER is accepted by B, create an ANSWER and send to A.

##### Disconnections

--------------------------------------------------------------------------------


* https://webrtchacks.com
* https://telecom.altanai.com/webrtc/

Unified Plan or Plan B (Group Call)
VP8* codec
ICE-TCP
JNI Bindings
PJSIP
webview

#### Others

##### tools
* [chrome webrtc internals](chrome://webrtc-internals/)
* [sipjs](https://sipjs.com/), JS library that takes care of WebRTC and SIP signaling.
* http://rtc.io/


Standards and protocols
* [W3C Media Capture and Streams](https://w3c.github.io/mediacapture-main/)
https://w3c.github.io/webrtc-pc/
https://tools.ietf.org/html/rfc7478
https://w3c.github.io/webrtc-pc/
https://datatracker.ietf.org/wg/rtcweb/documents/
https://tools.ietf.org/id/draft-ietf-rtcweb-jsep-21.html

* [Anatomy of a WebRTC SDP](https://webrtchacks.com/sdp-anatomy/)
* [How Zoom’s web client avoids using WebRTC](https://webrtchacks.com/zoom-avoids-using-webrtc/)
* [How to get webrtc-internals using js](https://stackoverflow.com/questions/24066850/is-there-an-api-for-the-chrome-webrtc-internals-variables-in-javascript)
* [ietf draft - Media Transport and Use of RTP](https://tools.ietf.org/html/draft-perkins-rtcweb-rtp-usage)
* [webrtc-internals documentation](https://testrtc.com/webrtc-internals-documentation/)


webrtcHacks – This site has a low frequency high quality publishing policy. The content is highly technical, very useful and stands the test of times. Whenever you have a technical issue with a “topic” in WebRTC – search it first on webrtcHacks for a detailed explanation
WebRTC Standards – This site focuses on the specification changes done in WebRTC. Follow it to make sure you prepare in advance for the modifications and additions coming to the standard. They also host a Live Q&A every month or so
WebRTC Glossary – This is a site I maintain. It holds the many acronyms and terms used in WebRTC with short explanations on each and some useful links to additional resources
WebRTC Weekly – The WebRTC Weekly curates the best content about WebRTC every week and sends it out via email to subscribers
WebRTC Index – This is where companies showcase their WebRTC products, and where you can find vendors to assist you with your own needs

https://webrtc.org/start/
https://github.com/webrtc/adapter the glue that sticks your code to the different browser implementations of WebRTC.
https://bloggeek.me/common-beginner-mistakes-in-webrtc/
https://github.com/webrtc/samples official samples repository with good clean code for you to use as reference
https://blog.addpipe.com/audio-constraints-getusermedia/
https://blog.addpipe.com/getusermedia-video-constraints/
https://blog.addpipe.com/common-getusermedia-errors/
https://www.callstats.io/blog/2017/12/12/signaling-state-changes
https://webrtc.org/architecture/
https://www.krankygeek.com/ https://www.youtube.com/channel/UC9qvM7eiCvDRO5Sm28byZiw/videos
https://webrtc.org/testing/wireshark/
https://websitebeaver.com/insanely-simple-webrtc-video-chat-using-firebase-with-codepen-demo
https://hacks.mozilla.org/category/webrtc/
https://webrtc-security.github.io/
https://www.pkc.io/blog/untangling-the-webrtc-flow/

https://bloggeek.me/how-webrtc-works/

#### Test
* https://test.webrtc.org/
* https://appr.tc/
* https://testrtc.com/webrtc-api-trace/


##### References:
  * https://webrtc.org/start/
